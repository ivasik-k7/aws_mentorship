### Розуміння основ AWS CloudTrail для журналювання активності API у сервісах AWS

AWS CloudTrail — це ключовий інструмент у екосистемі Amazon Web Services, який дозволяє записувати та відстежувати всі виклики API (Application Programming Interface) до сервісів AWS у вашому акаунті. Щоб зрозуміти його основи, розглянемо, що він робить, як працює і чому це важливо.

---

#### Що таке CloudTrail?

CloudTrail — це служба, яка фіксує деталі про дії, виконані у вашому AWS-оточенні. Кожен виклик API, наприклад, створення EC2-інстансу, зміна політики IAM чи завантаження файлу в S3, записується як "подія" (event). Ці записи зберігаються у вигляді логів, які можна переглядати, аналізувати та зберігати для подальшого використання.

Простіше кажучи, CloudTrail — це ваш "журнал активності", який показує:

- **Хто** виконав дію (користувач, роль чи сервіс).
- **Що** було зроблено (який API-виклик).
- **Коли** це сталося (час і дата).
- **Звідки** надійшов запит (IP-адреса, регіон тощо).
- **Результат** дії (успіх чи помилка).

---

#### Як працює CloudTrail?

1. **Запис подій**:

   - За замовчуванням CloudTrail автоматично записує **управлінські події** (management events) за останні 90 днів у консолі AWS без додаткових налаштувань. Це безкоштовно.
   - Щоб записувати всі події (включно з даними) і зберігати їх довше, потрібно створити "шлях" (trail).

2. **Типи подій**:

   - **Управлінські події (Management Events)**: Це дії, пов’язані з керуванням ресурсами, наприклад, створення VPC, налаштування IAM чи видалення балансувальника навантаження (ALB). Вони поділяються на:
     - **Читання** (Read): Перегляд конфігурації чи метаданих (наприклад, `DescribeInstances`).
     - **Запис** (Write): Зміна чи створення ресурсів (наприклад, `RunInstances`).
   - **Дані (Data Events)**: Деталізовані операції з об’єктами, наприклад, завантаження файлу в S3 чи виклик функції Lambda. Ці події вмикаються окремо.
   - **Insights Events**: Аналіз незвичайної активності, наприклад, різкого зростання викликів API (додаткова функція).

3. **Зберігання логів**:

   - Логи зберігаються в Amazon S3 (або іншому сховищі, якщо налаштовано), де їх можна архівувати чи аналізувати.
   - Без "траси" (trail) ви бачите лише 90 днів історії в консолі CloudTrail.

4. **Інтеграція**:
   - Логи можна підключити до Amazon CloudWatch для сповіщень у реальному часі.
   - Використовуйте Amazon Athena для аналізу логів у S3.

---

#### Як увімкнути журналювання активності API через усі сервіси?

Щоб CloudTrail записував активність API по всіх сервісах AWS:

1. **Створіть "шлях" (trail)**:
   - У консолі AWS або через Terraform/CLI задайте назву траси та виберіть S3-бакет для зберігання логів.
2. **Увімкніть глобальні події**:
   - Параметр `include_global_service_events = true` охоплює дії з глобальних сервісів, таких як IAM чи STS.
3. **Налаштуйте мультирегіональність**:
   - `is_multi_region_trail = true` записує події з усіх регіонів AWS, а не лише одного.
4. **Активуйте журналювання**:
   - `enable_logging = true` запускає запис подій.

---

#### Приклад

Припустимо, ви створили EC2-інстанс у регіоні `us-east-1` і змінили політику IAM у глобальному сервісі. CloudTrail запише:

- Подію `RunInstances` (створення інстансу) з деталями: хто (IAM-користувач), коли (час), де (регіон).
- Подію `UpdatePolicy` (зміна IAM) як глобальну подію.

Ці записи з’являться в логах у S3, якщо налаштовано "трасу".

---

#### Чому це важливо?

- **Безпека**: Ви можете виявити несанкціоновані дії, наприклад, якщо хтось із зовнішньої IP-адреси намагається змінити ресурси.
- **Аудит**: Дозволяє довести, що ваш акаунт відповідає стандартам (наприклад, PCI DSS).
- **Відлагодження**: Допомагає зрозуміти, чому щось пішло не так (наприклад, хто видалив ресурс).

---

#### Основи в кількох словах

CloudTrail — це служба для запису всіх API-дій у вашому AWS-акаунті. Вона:

- Фіксує управлінські та (за бажанням) дані події.
- Зберігає логи в S3 для аналізу чи архівації.
- Допомагає з аудитом, безпекою та моніторингом.

Налаштувавши CloudTrail із мультирегіональною трасою та глобальними подіями, ви отримаєте повне журналювання активності API через усі сервіси AWS.
